<script src="{{asset "js/vendor/libraries.min.js"}}"></script>
<script src="{{asset "js/vendor/bacon.js"}}"></script>
<script src="{{asset "js/vendor/plugins.min.js"}}"></script>
<script>
  (function(w,d,$,undefined){
    $(d).foundation();

    w.debug = false;

    // Constants
    var ACTIVE_CLASS = 'newsletter-panel--active';
    var CM_URL = 'https://rivalfox-closed.createsend.com/t/d/s/irlkc/?callback=?';

    // jQuery elements
    var $panel = $('.newsletter-panel');
    var $banner = $('.post-banner');
    var $article = $('.article');
    var $header = $('.header');
    var $userClose = $('.newsletter-panel .newsletter-panel__close');
    var $form = $('.newsletter-panel__form');
    var $emailInput = $('.newsletter-panel__email');
    var $submitButton = $('.newsletter-panel__submit');

    // Measurements
    var articleStart = $article.offset().top;
    var articleHeight = $article.height();
    var headerHeight = $header.height();
    var scrollEnd = articleStart + (articleHeight / 2);

    // Scroll observable
    var scrollStream = $(window)
      .asEventStream('scroll')
      .map(translateToY);

    scrollStream
      .filter(scrollIsWithinRange(scrollEnd))
      .filter(panelIsInactive)
      .subscribe(function(h){
        $panel.addClass(ACTIVE_CLASS);
      });

    scrollStream
      .filter(scrollIsWithinRange(headerHeight))
      .subscribe(function(h){
        $banner.addClass('is_active');
      });

    // Vanilla jQuery Event-bindings
    $userClose.on('click', function(e){
      e.preventDefault();

      closePanel();
    });

    $submitButton.on('click', function(e){
      e.preventDefault();

      $form.submit();
    })

    $form.on('submit', function(e){
      e.preventDefault();

      var data = $(this).serialize();

      $.ajax({
        url: CM_URL,
        dataType: 'json',
        data: data
      }).done(function(data, textStatus, xhrObject){
        if(data.Status === 200){
          closePanel();
        } else {
          alert(data.Message);
        }
      });
    })

    // Reducers
    function translateToY(){
      return window.scrollY;
    }

    function scrollIsWithinRange(endPos){
      return function(scrollPos){
        return scrollPos > endPos;
      }
    }

    function panelIsInactive(){
      return !$panel.hasClass(ACTIVE_CLASS);
    }

    function debug(){
      return w.debug;
    }

    // General functions
    function closePanel(){
      $panel.removeClass(ACTIVE_CLASS);
    }

  })(window,document,jQuery);
</script>
<script src="{{asset "js/app.min.js"}}"></script>
